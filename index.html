<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>タリスマン強化シミュレーター（完全版）</title>
<style>
  :root{--bg:#fff;--card:#f7f7f7;--line:#e0e0e0;--accent:#222;--muted:#666}
  *{box-sizing:border-box}
  body{font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; margin:0; background:var(--bg); color:var(--accent); padding:16px;}
  header{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
  h1{margin:0;font-size:18px}
  .top-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .controls{display:flex;gap:8px;align-items:center}
  .container{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .card{width:450px;background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--line)}
  .form{padding:6px}
  .slot{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  label.slot-label{min-width:84px;font-size:14px}
  select, input[type="text"]{padding:8px;border:1px solid var(--line);border-radius:6px;font-size:14px;background:white}
  button{padding:8px 10px;border-radius:6px;border:1px solid var(--line);background:white;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  /* results */
  .result{height:calc(100vh - 190px); overflow:auto}
  .section-title{font-weight:600;margin:0 0 8px 0;font-size:14px}
  .totals{margin-bottom:12px}
  .stat-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed var(--line);font-size:14px}
  .breakdown .mat{padding:8px;border-radius:6px;background:white;margin-bottom:8px;border:1px solid var(--line)}
  .breakdown h4{margin:0 0 6px 0;font-size:14px}
  table.effect-table{width:100%;border-collapse:collapse;font-size:11px}
  table.effect-table th, table.effect-table td{border:1px solid var(--line);padding:6px;text-align:left}
  .preset-list{max-height:140px;overflow:auto;margin-top:6px}
  /* responsive */
  @media (max-width:900px){
    .container{grid-template-columns:1fr}
    .result{height:auto;max-height:50vh}
    .card{padding:10px}
    label.slot-label{min-width:72px}
  }

  #
  margin-bottom: 120px;freeNotes
  } {
</style>
</head>
<body>

<header>
  <h1>タリスマン強化シミュレーター（完全版）</h1>
  <div class="top-row">
    <div class="controls">
      <label><input type="checkbox" id="useShield" checked> 盾を使う</label>
      <button id="resetBtn">リセット</button>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="presetName" type="text" placeholder="プリセット名（保存用）" />
      <button id="savePresetBtn">プリセット保存</button>
      <select id="loadPresetSelect"><option value="">プリセット読み込み</option></select>
      <button id="deletePresetBtn">削除</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">効果一覧（素材 × ランク）</div>
    <div id="effectTableArea" class="muted">読み込み中…</div>
  </div>
</header>

<div class="container">
  <div class="card form" id="formCard">
    <div class="section-title">装備スロット</div>
    <div id="formArea" style="margin-top:8px"></div>
  </div>

  <aside class="card result" id="resultCard">
    <div class="totals">
      <div class="section-title">合計ステータス</div>
      <div id="totalArea" class="muted">素材を選択してください</div>
    </div>

    <div class="breakdown">
      <div class="section-title">素材内訳（発生中のセット効果）</div>
      <div id="breakArea" class="muted">なし</div>
    </div>
  </aside>
</div>
<div class="free-note">
  <label for="freeText">フリーテキスト：</label><br>
  <textarea id="freeText" rows="5" style="width:100%;" placeholder="メモや追加情報を書けます"></textarea>
</div>
 
<script>
/* ========================
   データ：素材 × ランク別セット効果（編集しやすく）
   各値は数値（Number）またはパーセント文字列 "10%" の形で入力可能
   ======================== */
const MATERIALS = {
  "ソブリンの遺産": {
    uncommon: { set4: { "物理防御力": 121, "HP": 1100 } },
    rare:    { set3: { "物理防御力": 121, "魔法防御力": 121 }, set4: { "物理防御力": 121, "魔法防御力": 121, "HP": 1100 } },
    legendary: { set2: { "物理攻撃力": 121, "物理防御力": 121 }, set3: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121, "HP": 1100 } }
  },
  "ラヴェジャーの支配": {
    uncommon: { set4: { "物理攻撃力": 121, "HP": 1100 } },
    rare:    { set3: { "物理攻撃力": 121, "物理防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "HP": 1100 } },
    legendary: { set2: { "物理攻撃力": 121, "物理防御力": 121 }, set3: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121, "HP": 1100 } }
  },
  "神聖なる盾": {
    uncommon: { set4: { "HP": 1100, "回復倍率": "10%" } },
    rare:    { set3: { "物理防御力": 121, "HP": 1100 }, set4: { "物理防御力": 121, "HP": 1100, "回復倍率": "10%" } },
    legendary: { set2: { "物理防御力": 121, "魔法防御力": 121 }, set3: { "物理防御力": 121, "魔法防御力": 121, "HP": 1100 }, set4: { "物理防御力": 121, "魔法防御力": 121, "HP": 1100, "回復倍率": "10%" } }
  },
  "テンペストバウンド": {
    uncommon: { set4: { "物理防御力": 121, "HP": 1100 } },
    rare:    { set3: { "物理攻撃力": 121, "物理防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "HP": 1100 } },
    legendary: { set2: { "物理攻撃力": 121, "物理防御力": 121 }, set3: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121, "HP": 1100 } }
  },
  "ブレードウィーバー": {
    uncommon: { set4: { "物理攻撃力": 121, "HP": 1100 } },
    rare:    { set3: { "物理攻撃力": 121, "物理防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "HP": 1100 } },
    legendary: { set2: { "物理攻撃力": 121, "物理防御力": 121 }, set3: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121 }, set4: { "物理攻撃力": 121, "物理防御力": 121, "魔法防御力": 121, "HP": 1100 } }
  },
  "スペルファイア": {
    uncommon: { set4: { "魔法攻撃力": 121, "HP": 1100 } },
    rare:    { set3: { "魔法攻撃力": 121, "物理防御力": 121 }, set4: { "魔法攻撃力": 121, "物理防御力": 121, "HP": 1100 } },
    legendary: { set2: { "魔法攻撃力": 121, "物理防御力": 121 }, set3: { "魔法攻撃力": 121, "物理防御力": 121, "魔法防御力": 121 }, set4: { "魔法攻撃力": 121, "物理防御力": 121, "魔法防御力": 121, "HP": 1100 } }
  },
  "アストラル・コンフラックス": {
    uncommon: { set4: { "魔法攻撃力": 121, "MP": 1100 } },
    rare:    { set3: { "魔法攻撃力": 121, "HP": 1100 }, set4: { "魔法攻撃力": 121, "HP": 1100, "MP": 1100 } },
    legendary: { set2: { "魔法攻撃力": 121, "物理防御力": 121 }, set3: { "魔法攻撃力": 121, "物理防御力": 121, "HP": 1100 }, set4: { "魔法攻撃力": 121, "物理防御力": 121, "HP": 1100, "MP": 1100 } }
  },
  "セラフィックグレース": {
    uncommon: { set4: { "MP":1100, "回復倍率":"10%" } },
    rare:    { set3: { "HP":1100, "MP":1100 }, set4: { "HP":1100, "MP":1100, "回復倍率":"10%" } },
    legendary: { set2: { "物理防御力":121, "HP":1100 }, set3: { "物理防御力":121, "HP":1100, "MP":1100 }, set4: { "物理防御力":121, "HP":1100, "MP":1100, "回復倍率":"10%" } }
  },
  "勇気の砦": {
    uncommon: { set4: { "MP再生":99, "回避":66 } },
    rare:    { set3: { "MP再生":99, "回避":66 }, set4: { "MP再生":99, "回避":66, "移動速度":4 } },
    legendary: { set2: { "HP再生":99, "MP再生":99 }, set3: { "HP再生":99, "MP再生":99, "回避":66 }, set4: { "HP再生":99, "MP再生":99, "回避":66, "移動速度":4 } }
  },
  "ドラゴンクロー": {
    uncommon: { set4: { "命中":77, "クリティカル発生率":"5%" } },
    rare:    { set3: { "命中":77, "クリティカル発生率":"5%" }, set4: { "命中":77, "クリティカル発生率":"5%", "クリティカル倍率":"10%" } },
    legendary: { set2: { "HP再生":99, "命中":77 }, set3: { "HP再生":99, "命中":77, "クリティカル発生率":"5%" }, set4: { "HP再生":99, "命中":77, "クリティカル発生率":"5%", "クリティカル倍率":"10%" } }
  },
  "エルドリッチ・カタリスト": {
    uncommon: { set4: { "MP再生":99, "クリティカル発生率":"5%" } },
    rare:    { set3: { "HP再生":99, "MP再生":99 }, set4: { "HP再生":99, "MP再生":99, "クリティカル発生率":"5%" } },
    legendary: { set2: { "HP再生":99, "MP再生":99 }, set3: { "HP再生":99, "MP再生":99, "クリティカル発生率":"5%" }, set4: { "HP再生":99, "MP再生":99, "クリティカル発生率":"5%", "クリティカル倍率":"10%" } }
  },
  "神聖なる調和": {
    uncommon: { set4: { "HP再生":99, "MP再生":99 } },
    rare:    { set3: { "HP再生":99, "MP再生":99 }, set4: { "HP再生":99, "MP再生":99, "回復倍率":"10%" } },
    legendary: { set2: { "HP再生":99, "MP再生":99 }, set3: { "HP再生":99, "MP再生":99, "回避":66 }, set4: { "HP再生":99, "MP再生":99, "回避":66, "回復倍率":"10%" } }
  }
};

/* ======= 装備スロット ======= */
const ALL_SLOTS = ["武器","頭","胴体","腕","足","首飾り","指輪1","指輪2","イヤリング1","イヤリング2","腕輪","かばん","盾"];

/* ======= 初期化 / UI ビルド ======= */
let currentSlots = [...ALL_SLOTS];
const formArea = document.getElementById("formArea");
const effectTableArea = document.getElementById("effectTableArea");
const totalArea = document.getElementById("totalArea");
const breakArea = document.getElementById("breakArea");
const useShield = document.getElementById("useShield");

function buildForm(){
  formArea.innerHTML = "";
  currentSlots.forEach(slot=>{
    const div = document.createElement("div");
    div.className = "slot";
    // マテリアル選択とランク選択を並べる
    const matSelect = '<select class="mat-select"><option value="">未選択</option>'+Object.keys(MATERIALS).map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('')+'</select>';
    const rankSelect = '<select class="rank-select"><option value="legendary">レジェンダリー</option><option value="rare">レア</option><option value="uncommon">アンコモン</option></select>';
    div.innerHTML = '<label class="slot-label">'+escapeHtml(slot)+'</label>' + matSelect + rankSelect;
    formArea.appendChild(div);
  });
  // attach change handlers
  formArea.querySelectorAll('select').forEach(s=>s.addEventListener('change', updateAll));
  populatePresetList();
  updateEffectTable();
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ========== 効果一覧テーブル生成 ========== */
function updateEffectTable() {

  // ステータスオブジェクト → 改行区切りの「ステ名だけ」へ変換
  const formatStats = obj => {
    if (!obj) return '';
    return Object.keys(obj)
      .map(k => k.replace(/：.*/, "")) // 数値部分カット
      .join('<br>');
  };

  // レアリティごとにセットをまとめる
  const getRankText = (data, rankName, keys) => {
    if (!data[rankName]) return '';
    return keys
      .map(k => data[rankName][k] ? formatStats(data[rankName][k]) : '')
      .filter(Boolean)
      .join('<hr class="split">'); // セット間の区切り線
  };

  const mats = Object.keys(MATERIALS);
  let rows = '';

  mats.forEach(name => {
    const d = MATERIALS[name];

    const uncommon = getRankText(d, 'uncommon', ['set4']);
    const rare = getRankText(d, 'rare', ['set4']);
    const legendary = getRankText(d, 'legendary', ['set4']);

    rows += `
      <tr>
        <td class="mat-name">${escapeHtml(name)}</td>
        <td class="uncommon-cell">${uncommon}</td>
        <td class="rare-cell">${rare}</td>
        <td class="legend-cell">${legendary}</td>
      </tr>
    `;
  });

  effectTableArea.innerHTML = `
    <div class="scroll-table">
      <table class="effect-table">
        <thead>
          <tr>
            <th>タリスマン</th>
            <th class="uncommon-head">アンコモン</th>
            <th class="rare-head">レア</th>
            <th class="legend-head">レジェンダリー</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}
/* ========== 計算ロジック ========== */
/* ユーティリティ：値を数値化または % の扱いを分けて返す */
function parseValue(val){
  // val may be Number or string like "10%" or "1100"
  if (typeof val === 'number') return {type:'num', value: val};
  if (typeof val === 'string') {
    const s = val.trim();
    if (s.endsWith('%')){
      const n = parseFloat(s.replace('%',''));
      return {type:'pct', value: isNaN(n)?0:n};
    }
    const n = parseFloat(s.replace(/,/g,''));
    return {type:'num', value: isNaN(n)?0:n};
  }
  return {type:'num', value:0};
}

/* メイン更新関数 */
function updateAll(){
  // Gather selections
  const rows = [...formArea.querySelectorAll('.slot')];
  const selections = rows.map(r=>{
    const mat = r.querySelector('.mat-select').value;
    const rank = r.querySelector('.rank-select').value;
    return mat ? {name:mat, rank:rank} : null;
  }).filter(x=>x!==null);

  if (selections.length === 0){
    totalArea.innerHTML = '<div class="muted">素材を選択してください</div>';
    breakArea.innerHTML = '<div class="muted">なし</div>';
    return;
  }

  // Count per material, but note: same material may have different ranks in different slots.
  // Rule: count by material name regardless of per-slot rank, but effect selection depends on chosen rank per slot:
  // We'll treat each selected slot individually: for each slot we add 1 to a list keyed by name, storing rank selected for that occurrence.
  const perName = {}; // name -> array of ranks for each occurrence
  selections.forEach(s=>{
    perName[s.name] = perName[s.name] || [];
    perName[s.name].push(s.rank);
  });

  // Totals split: numeric and percent
  const totalsNum = {}; // {stat: number}
  const totalsPct = {}; // {stat: number} (sum of percent numbers)
  const breakdown = []; // array of {name, count, activations: [{setName, effectObj}]}

  // For each material name, we need to decide which set(s) activate based on occurrences of that material across slots,
  // but since each occurrence has a chosen rank we must resolve: We'll apply activation by treating each occurrence with its rank,
  // but activation thresholds are per-material overall count. We assume the highest-rank among occurrences applies for effect selection when threshold reached.
  // Simpler and intuitive approach (and matches earlier spec):
  // - determine total count = occurrences length
  // - determine "effective rank" = the highest rarity level present among occurrences (legendary > rare > uncommon).
  // - then apply activation rules based on effective rank and total count:
  //    uncommon: activates only if count >= 4 -> set4
  //    rare: if count==3 -> set3, if count>=4 -> set4
  //    legendary: if count==2 -> set2, if count==3 -> set3, if count>=4 -> set4
  const rankOrder = { 'uncommon': 0, 'rare': 1, 'legendary': 2 };

  for (const name in perName){
    const ranks = perName[name];
    const count = ranks.length;
    // pick effective rank = max rank among selected occurrences
    let effRank = 'uncommon';
    ranks.forEach(r=>{ if (rankOrder[r] > rankOrder[effRank]) effRank = r; });

    const entry = { name, count, effRank, activations: [] };
    const data = MATERIALS[name];

    if (!data) continue;

    // determine which set key to use based on effRank & count
    let setKey = null;
    if (effRank === 'uncommon'){
      if (count >= 4) setKey = 'set4';
    } else if (effRank === 'rare'){
      if (count === 3) setKey = 'set3';
      else if (count >= 4) setKey = 'set4';
    } else if (effRank === 'legendary'){
      if (count === 2) setKey = 'set2';
      else if (count === 3) setKey = 'set3';
      else if (count >= 4) setKey = 'set4';
    }

    if (setKey && data[effRank] && data[effRank][setKey]){
      const effectObj = data[effRank][setKey];
      // record activation
      entry.activations.push({ setKey, effectObj });
      // accumulate totals
      for (const [stat, rawVal] of Object.entries(effectObj)){
        const parsed = parseValue(rawVal);
        if (parsed.type === 'num'){
          totalsNum[stat] = (totalsNum[stat] || 0) + parsed.value;
        } else if (parsed.type === 'pct'){
          totalsPct[stat] = (totalsPct[stat] || 0) + parsed.value;
        }
      }
    }
    if (entry.activations.length > 0) breakdown.push(entry);
  }

  // Render totals: combine numeric and percent
  const lines = [];
  // numeric stats
  for (const stat in totalsNum){
    lines.push({ stat, text: `${stat}：${totalsNum[stat]}` });
  }
  // percent stats
  for (const stat in totalsPct){
    // Show integer if whole, else show with up to 2 decimals
    const val = totalsPct[stat];
    const display = (Math.abs(val - Math.round(val)) < 1e-9) ? Math.round(val) : Math.round(val*100)/100;
    lines.push({ stat, text: `${stat}：${display}%` });
  }
  // sort lines by stat name for stable display (optional)
  lines.sort((a,b)=> a.stat.localeCompare(b.stat));

  if (lines.length === 0){
    totalArea.innerHTML = '<div class="muted">発生中の合計ステータスはありません（同じ素材を2つ以上揃えるなどでセット効果が発動します）</div>';
  } else {
    totalArea.innerHTML = lines.map(l => `<div class="stat-row"><div>${escapeHtml(l.text.split('：')[0])}</div><div>${escapeHtml(l.text.split('：')[1])}</div></div>`).join('');
  }

  // Render breakdown
  if (breakdown.length === 0){
    breakArea.innerHTML = '<div class="muted">発生しているセット効果はありません</div>';
  } else {
    let html = '';
    breakdown.forEach(d=>{
      html += '<div class="mat"><h4>'+escapeHtml(d.name)+'（'+d.count+'個 → '+(d.activations[0].setKey)+'）</h4><ul>';
      for (const [k,v] of Object.entries(d.activations[0].effectObj)){
        html += '<li>'+escapeHtml(k)+'：'+escapeHtml(String(v))+'</li>';
      }
      html += '</ul></div>';
    });
    breakArea.innerHTML = html;
  }
}

/* ========== プリセット機能 (localStorage) ========== */
const PRESET_KEY = 'talismans_presets_v1';

function loadPresets(){
  try {
    const raw = localStorage.getItem(PRESET_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch(e){ return {}; }
}
function savePresets(obj){
  localStorage.setItem(PRESET_KEY, JSON.stringify(obj));
}
function populatePresetList(){
  const sel = document.getElementById('loadPresetSelect');
  const current = sel.value;
  sel.innerHTML = '<option value="">プリセット読み込み</option>';
  const presets = loadPresets();
  Object.keys(presets).forEach(name=>{
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  if (current) sel.value = current;
}
document.getElementById('savePresetBtn').addEventListener('click', ()=>{
  const name = document.getElementById('presetName').value.trim();
  if (!name){ alert('プリセット名を入力してください'); return; }
  const rows = [...formArea.querySelectorAll('.slot')];
  const data = rows.map(r=>{
    return {
      mat: r.querySelector('.mat-select').value || '',
      rank: r.querySelector('.rank-select').value || 'legendary'
    };
  });
  const presets = loadPresets();
  presets[name] = data;
  savePresets(presets);
  populatePresetList();
  alert('プリセットを保存しました：' + name);
});
document.getElementById('loadPresetSelect').addEventListener('change', (e)=>{
  const name = e.target.value;
  if (!name) return;
  const presets = loadPresets();
  const data = presets[name];
  if (!data) return;
  // apply
  const rows = [...formArea.querySelectorAll('.slot')];
  rows.forEach((r,i)=>{
    const rec = data[i];
    if (rec){
      r.querySelector('.mat-select').value = rec.mat;
      r.querySelector('.rank-select').value = rec.rank || 'legendary';
    } else {
      r.querySelector('.mat-select').value = '';
      r.querySelector('.rank-select').value = 'legendary';
    }
  });
  updateAll();
});
document.getElementById('deletePresetBtn').addEventListener('click', ()=>{
  const sel = document.getElementById('loadPresetSelect');
  const name = sel.value;
  if (!name){ alert('削除するプリセットを選んでください'); return; }
  const presets = loadPresets();
  if (!presets[name]) return;
  if (!confirm('プリセット「' + name + '」を削除しますか？')) return;
  delete presets[name];
  savePresets(presets);
  populatePresetList();
  alert('削除しました：' + name);
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.querySelectorAll('.mat-select').forEach(s=>s.value='');
  document.querySelectorAll('.rank-select').forEach(s=>s.value='legendary');
  updateAll();
});

/* 盾 ON/OFF */
useShield.addEventListener('change', ()=>{
  if (useShield.checked){
    if (!currentSlots.includes('盾')) currentSlots.push('盾');
  } else {
    currentSlots = currentSlots.filter(s => s !== '盾');
  }
  buildForm();
});

/* 初期ビルド */
buildForm();
/* 初期更新 */
updateAll();

</script>
</body>
</html>
